# Session Handoff - API 400 Empty Text Block Fix

> **Project:** Governance
> **Type:** OPS
> **Updated:** 2026-02-05

## Table of Contents

| Section | Title                                                  | Line |
|---------|--------------------------------------------------------|------|
| 1       | [Session Metadata](#1-session-metadata)                | :18  |
| 2       | [Work Summary](#2-work-summary)                        | :31  |
| 3       | [Issue Documentation](#3-issue-documentation)          | :44  |
| 4       | [Fix Procedure](#4-fix-procedure)                      | :82  |
| 5       | [Key Learnings](#5-key-learnings)                      | :118 |
| 6       | [Next Steps](#6-next-steps)                            | :138 |

---------------------------------------------------------------------------------------------------------------------------

## 1. Session Metadata

| Field        | Value                                    |
|--------------|------------------------------------------|
| Project      | Governance                               |
| Type         | OPS                                      |
| Date         | 2026-02-05                               |
| Start time   | 09:27                                    |
| End time     | 09:58                                    |
| Duration     | ~31 minutes                              |
| Claude model | claude-opus-4-5                          |

---------------------------------------------------------------------------------------------------------------------------

## 2. Work Summary

### Completed

- [x] Diagnosed API 400 error in fil-yuta session (c5f811ef)
- [x] Fixed 15 whitespace-only text blocks in session JSONL
- [x] Verified fix (session resumed successfully via `claude --resume`)
- [x] Documented the issue and fix procedure

### Pending

- [ ] Investigate root cause: what generates empty text blocks in JSONL

---------------------------------------------------------------------------------------------------------------------------

## 3. Issue Documentation

### Symptom

Fil-yuta session (ID: `c5f811ef-2eb2-43d8-ad6b-f925c2e48439`) became unusable.
Every message attempt returned:

```
API Error: 400 {"type":"error","error":{"type":"invalid_request_error",
"message":"messages: text content blocks must contain non-whitespace text"}}
```

### Root Cause

The session JSONL file contained 15 text content blocks with whitespace-only content (`"\n\n"`).
The Anthropic API validates that all `{"type": "text", "text": "..."}` blocks contain
at least one non-whitespace character. When Claude Code replays the conversation history
for each new API call, these invalid blocks cause a 400 rejection.

### Affected File

```
~/.claude/projects/-Users-mohammadshehata-Desktop-FILICITI-Products-FlowInLife-fil-yuta/
  c5f811ef-2eb2-43d8-ad6b-f925c2e48439.jsonl
```

### Why Standard Fixes Didn't Work Initially

1. **First attempt:** Replaced `"\n\n"` with `" "` (single space) - still whitespace-only
2. **Second attempt:** Replaced with `"."` (period) - passed API validation
3. **Session still errored** because the running process held OLD conversation in memory
4. **Solution:** Kill process (Ctrl+C) then `claude --resume` to reload from fixed file

---------------------------------------------------------------------------------------------------------------------------

## 4. Fix Procedure

### Step-by-step Runbook

**1. Identify the broken session file:**

```bash
ls -lht ~/.claude/projects/{PROJECT_PATH}/*.jsonl | head -5
# Look for today's date, largest recent file
```

**2. Scan for empty text blocks:**

```python
python3 -c "
import json
filepath = 'PATH_TO_SESSION.jsonl'
with open(filepath, 'r') as f:
    for lineno, line in enumerate(f, 1):
        line = line.strip()
        if not line: continue
        obj = json.loads(line)
        msg = obj.get('message', {})
        content = msg.get('content', [])
        if isinstance(content, list):
            for i, block in enumerate(content):
                if isinstance(block, dict) and block.get('type') == 'text':
                    t = block.get('text', '')
                    if not t.strip():
                        print(f'Line {lineno}, block {i}: {repr(t)}')
"
```

**3. Fix empty blocks (replace with non-whitespace):**

```python
python3 -c "
import json
filepath = 'PATH_TO_SESSION.jsonl'
lines = open(filepath).readlines()
fixed = 0
for i, line in enumerate(lines):
    stripped = line.strip()
    if not stripped: continue
    obj = json.loads(stripped)
    msg = obj.get('message', {})
    content = msg.get('content', [])
    changed = False
    if isinstance(content, list):
        for block in content:
            if isinstance(block, dict) and block.get('type') == 'text':
                if not block['text'].strip():
                    block['text'] = '.'
                    changed = True
                    fixed += 1
    if changed:
        lines[i] = json.dumps(obj) + '\n'
with open(filepath, 'w') as f:
    f.writelines(lines)
print(f'Fixed {fixed} blocks')
"
```

**4. Restart the session:**

```bash
# Kill the broken session (Ctrl+C in that terminal)
# Then resume from the fixed file:
cd /path/to/project
claude --resume
```

---------------------------------------------------------------------------------------------------------------------------

## 5. Key Learnings

1. **In-memory vs on-disk:** Editing the JSONL file does NOT fix a running session.
   The process must be restarted to reload from disk.

2. **Whitespace means non-empty:** A space `" "` is still whitespace-only.
   The API requires at least one non-whitespace character (e.g., `"."`).

3. **Error is literal:** The error message "text content blocks must contain
   non-whitespace text" is accurate and specific - not misleading in this case.

4. **Cannot run two sessions on same file:** Opening a second terminal with
   `claude --resume` while the first is still running causes file conflicts.

5. **Root cause unknown:** What generates these `"\n\n"` text blocks is unclear.
   Possibly hooks, compaction, or Claude responses with empty content.

---------------------------------------------------------------------------------------------------------------------------

## 6. Next Steps

### Immediate

1. Monitor for recurrence - if it happens again, check which operation creates the empty blocks
2. Consider a preventive hook that validates JSONL after each session

### Carried Over

- Fix v3.3 session timer corruption bug
- Resolve hash vs session ID architecture issue

---------------------------------------------------------------------------------------------------------------------------

**Session finalized**: 2026-02-05 09:58
**Next session priority**: Monitor for empty text block recurrence
