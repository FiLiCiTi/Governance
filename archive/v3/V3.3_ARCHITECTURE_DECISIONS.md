# v3.3 Architecture Decisions

> **Version:** 3.3.0
> **Date:** 2026-01-18
> **Status:** Implementation In Progress

---

## Table of Contents

| Section | Title                                    | Line   |
|---------|------------------------------------------|--------|
| 1       | [Overview](#1-overview)                  | :22    |
| 2       | [Key Decisions](#2-key-decisions)        | :45    |
| 3       | [State File Architecture](#3-state-file-architecture) | :120 |
| 4       | [Hook Architecture](#4-hook-architecture) | :200   |
| 5       | [Migration Strategy](#5-migration-strategy) | :350  |
| 6       | [Implementation Plan](#6-implementation-plan) | :450 |

---

## 1. Overview

### Purpose

v3.3 is a major refactoring of the hook system to achieve:
- **One Hook = One Function** (strict single responsibility)
- **Separation of Concerns** (decoupled state files)
- **Clear Naming** (verb_noun.sh convention)
- **No Deprecated Code** (remove warmup concept)

### Problems Fixed

**From v3.0/v3.2:**
1. ‚ùå Hooks violate single responsibility principle
2. ‚ùå State file couples unrelated concerns (time + context + tools)
3. ‚ùå State corruption causes cascading failures (~0K* + 29M minutes)
4. ‚ùå Deprecated warmup concept still in codebase
5. ‚ùå Unclear hook naming (inject_context.sh doesn't inject context)
6. ‚ùå No model name display in status bar

---

## 2. Key Decisions

### Decision A: State File Consolidation

**Decision:** 3 consolidated state files (session, context, tools)

**Rationale:**
- Critical separation (time vs context) for fault isolation
- Not too fragmented (easier to manage than 5 files)
- Clear ownership boundaries

**State Files:**

| File | Purpose | Owned By | Fields |
|------|---------|----------|--------|
| `{HASH}_session.json` | Session state | init_session.sh, track_time.sh, finalize_session.sh | start_time, end_time, last_update, status, project, project_name, log_file, model |
| `{HASH}_context.json` | Context tracking | track_context.sh, check_context_usage.sh, reset_context.sh | token_count, last_calibration, context_factor |
| `{HASH}_tools.json` | Tool tracking | log_tool.sh | tool_count, last_tool, last_tool_time |

**Benefits:**
- ‚úÖ Time corruption doesn't crash context tracking
- ‚úÖ Context corruption doesn't crash time tracking
- ‚úÖ Independent failure modes

---

### Decision B: Two Stop Hooks

**Decision:** Keep two separate Stop hooks (session duration + context usage)

**Rationale:**
- Clear separation of concerns (time ‚â† context)
- Independent failure modes
- Can disable one without affecting the other
- Easier to adjust thresholds independently

**Hooks:**
- `check_session_duration.sh` - Warns if session too long
- `check_context_usage.sh` - Warns if context too high

**Thresholds:**

| Hook | Warning | Critical |
|------|---------|----------|
| Session Duration | ‚â•120m (2h): ‚ö†Ô∏è | ‚â•150m (2.5h): üî¥ |
| Context Usage | ‚â•70%: üü° | ‚â•85%: üî¥ |

---

### Decision C: Model Name in Status Bar

**Decision:** Manual model name update, displayed first in status bar

**Configuration:**
- **Position:** First (leftmost)
- **Validation:** Freeform (no strict checking)
- **Default:** "sonnet" (lowercase)

**Storage:** `{HASH}_session.json`
```json
{
  "model": "sonnet",
  "model_confirmed_at": 1768743045
}
```

**Display Format:**
```
Sonnet ¬∑ üü¢ Context: ~45K ¬∑ ‚úÖ üïê 28m ¬∑ üîß Bash
^^^^^^^
Model name (capitalized for display)
```

**User Update Flow:**
```
User: "set model to Opus"
Claude: Updates session.json via jq
Status bar: Automatically reflects change
```

---

### Decision D: Backwards Compatibility

**Decision:** Auto-migrate v3.0 ‚Üí v3.3 (Option A)

**Rationale:**
- Governance is actively used - can't afford data loss
- Migration is one-time cost
- Can remove migration code in v4.0 (3 months from now)

**Migration Trigger:**
- Runs automatically in `init_session.sh` on first SessionStart
- Detects old unified state file format
- Splits into 3 new files
- Archives old file as `.v3.0.backup`

**Cleanup Plan:**
- v3.3.0 (2026-01-18): Add migration logic
- v3.3.1 (2026-04-18): Remove migration code (assumes all projects migrated)

---

### Decision E: Compact Flag Location

**Decision:** Dedicated `reset_context.sh` hook (Option 3)

**Rationale:**
- Compact is a distinct operation (deserves own hook)
- Keeps init_session.sh focused on initialization only
- Easy to maintain/test/understand
- Clear naming: `reset_context.sh` = exactly what it does

**Hook Order:**
```json
"SessionStart": [
  {
    "hooks": [
      {"command": "init_session.sh"},      // 1. Initialize session state
      {"command": "reset_context.sh"}      // 2. Handle compact flag if exists
    ]
  }
]
```

---

### Decision F: Naming Convention

**Decision:** `verb_noun.sh` format (strict)

**Examples:**
- `init_session.sh` (initialize session)
- `track_context.sh` (track context usage)
- `validate_boundaries.sh` (validate file boundaries)
- `check_session_duration.sh` (check session duration)
- `finalize_session.sh` (finalize session)

**Special cases:**
- `status_bar.sh` (noun only, acceptable for display hooks)
- `detect_loop.sh` (already follows pattern, keep as-is)

---

## 3. State File Architecture

### State File Locations

```
~/.claude/sessions/
‚îú‚îÄ {PROJECT_HASH}_session.json    # Session state
‚îú‚îÄ {PROJECT_HASH}_context.json    # Context tracking
‚îú‚îÄ {PROJECT_HASH}_tools.json      # Tool tracking
‚îî‚îÄ 20260118_053000.json           # Archived sessions
```

### Schema Definitions

#### File 1: `{HASH}_session.json`

**Purpose:** Session timing and metadata

```json
{
  "start_time": 1768743045,
  "end_time": null,
  "last_update": 1768743841,
  "status": "active",
  "project": "/Users/mohammadshehata/Desktop/FILICITI/Governance",
  "project_name": "governance",
  "log_file": "./Conversations/20260118_0530.log",
  "model": "sonnet",
  "model_confirmed_at": 1768743045
}
```

**Owned by:**
- `init_session.sh` (create/initialize)
- `track_time.sh` (update last_update)
- `finalize_session.sh` (set end_time, archive)

**Field Definitions:**

| Field | Type | Purpose | Set By |
|-------|------|---------|--------|
| `start_time` | Unix timestamp | Session start | init_session.sh |
| `end_time` | Unix timestamp | Session end | finalize_session.sh |
| `last_update` | Unix timestamp | Last activity | track_time.sh |
| `status` | String | "active" or "finalized" | init_session.sh, finalize_session.sh |
| `project` | String | Absolute project path | init_session.sh |
| `project_name` | String | Basename of project | init_session.sh |
| `log_file` | String | Relative path to log | init_session.sh |
| `model` | String | Current model name | User instruction |
| `model_confirmed_at` | Unix timestamp | When model was set | User instruction |

---

#### File 2: `{HASH}_context.json`

**Purpose:** Context tracking and calibration

```json
{
  "token_count": 15818,
  "last_calibration": 0,
  "context_factor": 1.0
}
```

**Owned by:**
- `track_context.sh` (update token_count)
- `reset_context.sh` (reset on compact)
- `check_context_usage.sh` (read for warnings)

**Field Definitions:**

| Field | Type | Purpose | Set By |
|-------|------|---------|--------|
| `token_count` | Integer | Cumulative tokens | track_context.sh |
| `last_calibration` | Unix timestamp | Last calibration | User command |
| `context_factor` | Float | Calibration multiplier | User command |

---

#### File 3: `{HASH}_tools.json`

**Purpose:** Tool usage tracking

```json
{
  "tool_count": 16,
  "last_tool": "Bash",
  "last_tool_time": 1768743841
}
```

**Owned by:**
- `log_tool.sh` (update all fields)

**Field Definitions:**

| Field | Type | Purpose | Set By |
|-------|------|---------|--------|
| `tool_count` | Integer | Total tools used | log_tool.sh |
| `last_tool` | String | Last tool name | log_tool.sh |
| `last_tool_time` | Unix timestamp | When last tool ran | log_tool.sh |

---

## 4. Hook Architecture

### Complete Hook List (10 hooks)

| # | Hook Name | Type | Event | Purpose |
|---|-----------|------|-------|---------|
| 1 | `init_session.sh` | Hook | SessionStart | Initialize session state |
| 2 | `reset_context.sh` | Hook | SessionStart | Handle compact flag |
| 3 | `track_context.sh` | Hook | PostToolUse | Update token count |
| 4 | `track_time.sh` | Hook | PostToolUse | Update session timer |
| 5 | `log_tool.sh` | Hook | PostToolUse | Log tool usage |
| 6 | `validate_boundaries.sh` | Hook | PreToolUse (Edit/Write) | Validate file paths |
| 7 | `detect_loop.sh` | Hook | PostToolUse | Detect infinite loops |
| 8 | `check_session_duration.sh` | Hook | Stop | Warn if session too long |
| 9 | `check_context_usage.sh` | Hook | Stop | Warn if context too high |
| 10 | `finalize_session.sh` | Hook | SessionEnd | Archive session |

**Additional (not hooks):**
- `status_bar.sh` - Status line display (continuous)
- Utilities: `audit_sessions.sh`, `check_protocol.sh`, `sync_templates.sh`

---

### Hook Dependencies & Flow

```
SESSION START
    ‚Üì
1. init_session.sh (SessionStart)
    ‚îú‚îÄ Calculate PROJECT_HASH
    ‚îú‚îÄ Check for old v3.0 state (auto-migrate if found)
    ‚îú‚îÄ Create/restore session.json, context.json, tools.json
    ‚îî‚îÄ Output session metadata
    ‚Üì
2. reset_context.sh (SessionStart)
    ‚îú‚îÄ Check for ~/.claude/compact_flag
    ‚îú‚îÄ If exists: Reset session start_time + context token_count
    ‚îî‚îÄ Delete flag
    ‚Üì
DURING SESSION (per tool use)
    ‚Üì
3. validate_boundaries.sh (PreToolUse - Edit/Write only)
    ‚îú‚îÄ Read CLAUDE.md boundaries
    ‚îú‚îÄ Validate file path
    ‚îî‚îÄ Approve or deny
    ‚Üì
[Tool executes]
    ‚Üì
4. track_context.sh (PostToolUse)
    ‚îú‚îÄ Estimate tokens from input length
    ‚îî‚îÄ Update context.json: token_count += estimated
    ‚Üì
5. track_time.sh (PostToolUse)
    ‚îî‚îÄ Update session.json: last_update = NOW
    ‚Üì
6. log_tool.sh (PostToolUse)
    ‚îú‚îÄ Log to ~/.claude/audit/tool_use.log
    ‚îî‚îÄ Update tools.json: tool_count++, last_tool, last_tool_time
    ‚Üì
7. detect_loop.sh (PostToolUse)
    ‚îú‚îÄ Track file edits
    ‚îú‚îÄ Track errors
    ‚îî‚îÄ Warn if loop detected
    ‚Üì
[Between tool calls]
    ‚Üì
8. check_session_duration.sh (Stop)
    ‚îú‚îÄ Read session.json: start_time
    ‚îú‚îÄ Calculate duration
    ‚îî‚îÄ Warn if ‚â•2h or ‚â•2.5h
    ‚Üì
9. check_context_usage.sh (Stop)
    ‚îú‚îÄ Read context.json: token_count, context_factor
    ‚îú‚îÄ Calculate context %
    ‚îî‚îÄ Warn if ‚â•70% or ‚â•85%
    ‚Üì
[Real-time]
    ‚Üì
10. status_bar.sh (Status Line - continuous)
    ‚îú‚îÄ Read session.json: model, start_time
    ‚îú‚îÄ Read context.json: token_count, context_factor
    ‚îú‚îÄ Read tools.json: last_tool, last_tool_time
    ‚îî‚îÄ Display: Model ¬∑ Context ¬∑ Duration ¬∑ Last Tool
    ‚Üì
SESSION END
    ‚Üì
11. finalize_session.sh (SessionEnd)
    ‚îú‚îÄ Read all state files
    ‚îú‚îÄ Calculate duration
    ‚îú‚îÄ Set status = "finalized"
    ‚îú‚îÄ Archive to timestamped file
    ‚îî‚îÄ Delete current state files
```

---

## 5. Migration Strategy

### Auto-Migration (v3.0 ‚Üí v3.3)

**Trigger:** `init_session.sh` on first SessionStart

**Detection Logic:**
```bash
OLD_FILE="$HOME/.claude/sessions/${PROJECT_HASH}_session.json"

# Check if old unified file exists
if [[ -f "$OLD_FILE" ]]; then
    # Check if it's v3.0 format (has token_count in session file)
    if jq -e '.token_count' "$OLD_FILE" > /dev/null 2>&1; then
        # OLD FORMAT DETECTED - MIGRATE
    fi
fi
```

**Migration Steps:**

1. **Backup old file:**
   ```bash
   cp "$OLD_FILE" "$OLD_FILE.v3.0.backup"
   ```

2. **Split into 3 files:**
   ```bash
   # session.json (time + metadata + model)
   jq '{
     start_time, end_time, last_update, status,
     project, project_name, log_file,
     model: (.model // "sonnet"),
     model_confirmed_at: (.model_confirmed_at // .start_time)
   }' "$OLD_FILE" > "${OLD_FILE%.json}_session.json"

   # context.json (token tracking + calibration)
   jq '{
     token_count, last_calibration, context_factor
   }' "$OLD_FILE" > "${OLD_FILE%.json}_context.json"

   # tools.json (tool tracking)
   jq '{
     tool_count: (.tool_count // 0),
     last_tool: "--",
     last_tool_time: 0
   }' "$OLD_FILE" > "${OLD_FILE%.json}_tools.json"
   ```

3. **Log migration:**
   ```bash
   echo "$(date -Iseconds) | Migration: v3.0 ‚Üí v3.3 | $PROJECT" >> \
        "$HOME/.claude/sessions/migration.log"
   ```

4. **Delete old unified file:**
   ```bash
   rm "$OLD_FILE"
   ```

**Rollback Plan:**

If v3.3 has issues:
```bash
# Restore from backup
cd ~/.claude/sessions
mv {HASH}_session.json.v3.0.backup {HASH}_session.json
rm {HASH}_context.json {HASH}_tools.json

# Revert settings.json to v3.0 hooks
# (keep old hooks in scripts/deprecated/ for this purpose)
```

---

### Fields Removed (v3.0 ‚Üí v3.3)

**Removed fields:**
- `last_warmup` - DEPRECATED (warmup concept removed)
- `duplicate_session` - Unused
- `todo_total` - Should be in separate todo state (not session state)
- `todo_done` - Should be in separate todo state (not session state)

**Note:** Todo tracking should be in Claude Code's native `todo_state.json`, not our session state.

---

## 6. Implementation Plan

### Phase 1: Create New Hooks (2026-01-18)

**Order:**
1. ‚úÖ Create v3.3 architecture document (this file)
2. ‚è≥ Implement `init_session.sh` (with migration logic)
3. ‚è≥ Implement `reset_context.sh`
4. ‚è≥ Implement `track_context.sh`
5. ‚è≥ Implement `track_time.sh`
6. ‚è≥ Implement `log_tool.sh`
7. ‚è≥ Rename `check_boundaries.sh` ‚Üí `validate_boundaries.sh`
8. ‚è≥ Keep `detect_loop.sh` as-is (already good)
9. ‚è≥ Implement `check_session_duration.sh`
10. ‚è≥ Implement `check_context_usage.sh`
11. ‚è≥ Implement `finalize_session.sh`
12. ‚è≥ Implement `status_bar.sh`

### Phase 2: Update Configuration

13. ‚è≥ Update `settings.json` with new hooks
14. ‚è≥ Update `HOOKS_ARCHITECTURE.md` for v3.3

### Phase 3: Archive Old Hooks

15. ‚è≥ Create `scripts/deprecated/` directory
16. ‚è≥ Move old hooks to deprecated:
    - `inject_context.sh` ‚Üí `deprecated/`
    - `log_tool_use.sh` ‚Üí `deprecated/`
    - `check_warmup.sh` ‚Üí `deprecated/`
    - `suggest_model.sh` ‚Üí `deprecated/`
    - `save_session.sh` ‚Üí `deprecated/`
    - `check_boundaries.sh` ‚Üí `deprecated/`

### Phase 4: Testing

17. ‚è≥ Test migration (v3.0 ‚Üí v3.3)
18. ‚è≥ Test fresh session start
19. ‚è≥ Test compact flag flow
20. ‚è≥ Test status bar display
21. ‚è≥ Test Stop hooks (warnings)
22. ‚è≥ Test session finalization

### Phase 5: Documentation

23. ‚è≥ Update `CONTEXT.md` with v3.3 status
24. ‚è≥ Create session handoff documenting v3.3 implementation
25. ‚è≥ Update `V3_FULL_SPEC.md` (if needed)

---

## Success Criteria

### Must Have (Blocking)
- ‚úÖ All 10 new hooks implemented
- ‚úÖ Auto-migration works (v3.0 ‚Üí v3.3)
- ‚úÖ No data loss during migration
- ‚úÖ Status bar displays correctly
- ‚úÖ Compact flag resets context + time
- ‚úÖ State file corruption is isolated (no cascading failures)

### Should Have (Important)
- ‚úÖ Model name displays in status bar
- ‚úÖ Old hooks archived (not deleted)
- ‚úÖ Migration logged to migration.log
- ‚úÖ Rollback plan documented

### Nice to Have (Optional)
- ‚è≥ Automated tests for each hook
- ‚è≥ Performance benchmarks (hook execution time)
- ‚è≥ Migration statistics (how many sessions migrated)

---

**Document Version:** 1.0
**Status:** Implementation Started
**Next Review:** After Phase 4 (Testing)
